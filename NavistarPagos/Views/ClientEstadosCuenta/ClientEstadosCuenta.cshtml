@model NavistarPagos.Models.MesesC

@{
    ViewBag.Title = "ClientEstadosCuenta";
}


<div class="container text-center" style="margin-top:5px;margin-bottom:5px;">
    <h1 class="AccountName">Bienvenido @ViewBag.Name</h1>
</div>
<div class="row" style="margin:0!important; padding:0 !important; max-width:100%;">
    <div class="col-md-1"></div>
    <div class="col-md-10" style="backgrouznd-color: #03345F; max-width: 100%; height: 3px; margin-top: 0px;">
        <div class="row">
            <div class="col-md-12" style="text-align: center;">
                <br /><br />
                <h5>Seleccione el contrato y el mes que desee consultar</h5>
                @*@Html.ActionLink("Descargar PDF", "DescargarPDFDesdeAPI", "TuControlador", new { filename = "638094701099190053.PNG" })*@

            </div>

        </div>
        <div class="row">
            <div class="col-md-12" style="text-align: center;">


                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-6">
                            @if (ViewBag.Meses != null)
                            {
                                @Html.DropDownListFor(model => model.Mes, new SelectList(ViewBag.Meses, "AnioMes", "Mes", 0), new { @class = "form-control", id = "ddlFecha" })

                            }
                        </div>
                        <div class="col-md-6">
                            @if (ViewBag.Contratos != null)
                            {
                                @Html.DropDownListFor(model => model.vContrato, new SelectList(ViewBag.Contratos, "vContrato", "vContrato", 0), new { @class = "form-control", id = "ddlContratos" })

                            }
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9"> </div>
                        <div class="col-md-3">
                            <div class="row">
                                <div class="col-md-12">
                                    <br />
                                    <div class="form-group">
                                        <div class="row" style="display: flex; justify-content: center;">
                                            <div class="col-sm-6">
                                                @*<div id="dAjaxLoader" class="form-group row" style="margin-top: 10px; height: 50px; display:flex; justify-content: center;">
                                                        <img id="AjaxLoader" alt="Cargando..." style="display: none" src="~/img/spin.gif" />
                                                    </div>*@
                                                <input type="submit" name="login-submit" id="login-submit" tabindex="4" class="btn-primary-NFCx" value="Descargar" onclick="descargarArchivo()">

                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <div style="height:500px;"></div>
        <div class="row">
            <div class="col-md-12" style="text-align: center;">
                <br /><br />
                <h5 class="AccountName" style="font-size: 1em !important; " >En caso de dudas o aclaraciones comunícate con nosotros al 800 7000 123</h5>                

            </div>

        </div>

    </div>
    <div class="col-md-1"></div>
</div>
<div id="ModalSinContratos" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="bs-example-modal-lg" aria-modal="true" style="display: none;" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <input type="hidden" id="SinContratoempleadoID" name="SinContratoempleadoID" value="0" />
                <h4 id="lblAccionSinContrato" class="swal-title"><span style="font-weight:bold"> Navistar Financial</span></h4>
                <input type="hidden" id="hfA" name="hfAccionIDSinContrato" value="" />

            </div>

            <div class="modal-body">

                <div class="row">

                    <div class="col-md-12">
                        <div class="form-group">

                            <div id="add_to_me_SinContrato" class="swal-text" style="margin-top:5px;">

                            </div>
                            <br />

                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-3"></div>
                    <div class="col-md-2"> </div>
                    <div class="col-md-6" style="text-align:right;">

                        <button type="button" class="btn btn-danger" id="btnCancelarSinContrato" onclick="ReturnPageInit()">Cancelar</button>
                        <br />
                    </div>
                    <div class="col-md-1"> </div>
                </div>
                <div class="row">
                    <div class="col-md-12"><br /> </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="ModalResetContrasena" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="bs-example-modal-lg" aria-modal="true" style="display: none;" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <input type="hidden" id="empleadoID" name="empleadoID" value="0" />
                <h4 id="lblAccion" class="swal-title"><span style="font-weight:bold"> Navistar Financial</span></h4>
                <input type="hidden" id="hfAccionID" name="hfAccionID" value="" />

            </div>

            <div class="modal-body">

                <div class="row">

                    <div class="col-md-12">
                        <div class="form-group">

                            <div id="add_to_me" class="swal-text" style="margin-top:5px;">

                            </div>
                            <br />

                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-3"></div>
                    <div class="col-md-2"> </div>
                    <div class="col-md-6" style="text-align:right;">
                        <button type="button" class="btn btn-success" id="btnGuardar" onclick="CerrarModal()">Aceptar</button>

                        <button type="button" class="btn btn-danger" id="btnCancelar" onclick="ReturnPageInit()">Cancelar</button>
                        <br />
                    </div>
                    <div class="col-md-1"> </div>
                </div>
                <div class="row">
                    <div class="col-md-12"><br /> </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="ModalProcesando" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="bs-example-modal-lg" aria-modal="true" style="display: none; padding-top:180px;" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-md">
        <br /><br /><br />
        <div class="modal-content">


            <div class="modal-body">


                <div class="row">
                    <div class="col-md-4"></div>
                    <div class="col-md-4">
                        <div id="dAjaxLoader" class="form-group row" style="margin-top: 10px; height: 50px; display:flex; justify-content: center;">
                            <img id="AjaxLoader" alt="Cargando..." style="display: none" src="~/img/spin.gif" /><span style=" margin-top: 20px; text-align: center; font-family: 'Roboto Condensed', sans-serif; font-weight: bold; font-style: normal; font-size: medium; color: #00355f; ">Procesando Información</span>
                        </div>

                    </div>
                    <div class="col-md-4"> </div>

                </div>
                <div class="row">
                    <div class="col-md-12"><br /> </div>
                </div>

            </div>
        </div>
    </div>
</div>



<script type="text/javascript">
    $(document).ready(function () {

        seleccionarPopupMessage();
    });

    function desplegarMensaje() {

        seleccionarPopupMessage();

    }

    function seleccionarPopupMessage() {
        var cve = $("#ddlCliente").val();
        var action = '@ViewBag.Action';

        //alert(action);

        var dataRq = new Object();
        dataRq.recurso = rutaAccount + "Home/" + "SeleccionarPopMessage";


        $("#AjaxLoader").show("fast");
        $.ajax({
            url: "@Url.Action("SeleccionarPopMessage", "Home")",
            data: { psAction: action },
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function (data) {
                var bSuccess = data.success;
                var lst = data.lstPop;
                if (bSuccess) {
                    //sweetalerts('Navistar Financial', 'Cliente sin contratos', 'warning', 'Aceptar');
                    $('#add_to_me').empty();
                    for (const i of lst) {
                        if (i.Texto !== undefined) {
                            //$('#cboColonia').append(`<option value="${i.value}">${i.text}</option>`);
                            $('#add_to_me').append(`${i.Texto} <a class = 'btn-link'target="_blank" href="${i.Url}"> Términos y condiciones </a> ${i.Texto2} `)
                        }
                    }
                    $('#ModalResetContrasena').modal('show');
                } else {

                    var urlRef = "/Home/" + action;

                    window.location.href = urlRef;

                    //window.location.href = '@Url.Content("~/Home/ClientFiles")';
                }

                $("#AjaxLoader").hide("slow");
            },
            error: function (xhr, status, error) {
                var errorText = xhr.responseText.toString();

                $("#AjaxLoader").hide("slow");
                //sweetalerts('Runsa', 'Se produjo un error: ' + errorText + ', al realizar la búsqueda', 'error', 'Aceptar');
            },
        });
    }

    function AbrirPopupProcesando() {

        $('#ModalProcesando').modal('show');
        $("#AjaxLoader").show("fast");
    }

    function CerrarPopupProcesando() {

        $('#ModalProcesando').modal('hide');
        $("#AjaxLoader").hide("slow");
    }

    function CerrarModal() {
        RegistraBitacoraMessagePop();
        $('#ModalResetContrasena').modal('hide');
    }

    function ReturnPageInit() {
        var sessionToken = '@Session["tokenUsr_1"]';
        //Prod descomentar
        //var urlRef = "/NavistarPagos/Home/Index" + '?ntoken=' + sessionToken + "&psAction=ClientEstadosCuenta";
        //Desarrollo comentar en prod
        var urlRef = "/Home/Index"  + '?ntoken=' + sessionToken + "&psAction=ClientCons" ;
        window.location.href = urlRef;
        $('#ModalResetContrasena').modal('hide');
    }

    function RegistraBitacoraMessagePop()
    {
        var psVista = 'ClientEstadosCUenta';

        $.ajax({
            url: "@Url.Action("RegistraBitacoraPM", "Home")",
            type: 'POST',
            data: { psVista: psVista },
            success: function (data) {
                var bSuccess = data.success;

                if (bSuccess) {

                } else {

                }
            },
            error: function (xhr, status, error) {
                alert('Error al enviar la solicitud');
                $("#AjaxLoader").hide("slow");
            },
        });
    }

    function seleccionarCliente() {



        $("#AjaxLoader").show("fast");
        $.ajax({
            url: "@Url.Action("SeleccionarContratos", "ClientEstadosCuenta")",
            data: { cve: 0, psAction: 'uno' },
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function (data) {
                var bSuccess = data.success;

                if (!bSuccess) {
                    sweetalerts('Navistar Financial', 'Cliente sin contratos', 'warning', 'Aceptar');
                } else {
                    //alert(action);
                    var urlRef = "/" + action + "/" + action;
                    window.location.href = urlRef;

                    //window.location.href = '@Url.Content("~/Home/ClientFiles")';
                    $("#AjaxLoader").hide("slow");
                }

                $("#AjaxLoader").hide("slow");
            },
            error: function (xhr, status, error) {
                var errorText = xhr.responseText.toString();
                alert('error')
                $("#AjaxLoader").hide("slow");
                //sweetalerts('Runsa', 'Se produjo un error: ' + errorText + ', al realizar la búsqueda', 'error', 'Aceptar');
            },
        });
    }

    async function descargarArchivo() {
        try
        {


            // Obtener el elemento DropDownList
            var ddlContratos = document.getElementById("ddlContratos");
            var ddlFecha = document.getElementById("ddlFecha");

            // Obtener el valor seleccionado (ID)
            var selectedIdContratos = ddlContratos.options[ddlContratos.selectedIndex].value;
            var selectedIdFecha = ddlFecha.options[ddlFecha.selectedIndex].value;

            if (selectedIdFecha === "190000") {
                mostrarAlerta('danger', 'Por favor, selecciona un mes válido.');
                return;
            }

            if (selectedIdContratos === 'Seleccionar contrato') {
                mostrarAlerta('danger', 'Por favor, selecciona un contrato válido.');
                return;
            }

            //EjemploPaperless
            //var urlRef = "/NavistarPagos/ClientPaperless/Index" + '?ntoken=' + sessionToken + "&psAction=ClientPaperless";
            AbrirPopupProcesando();
            // Llamada al método en el servidor
            const response = await fetch('/ClientEstadosCuenta/DescargarPDFDesdeAPI', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ contratosFechas: selectedIdFecha + '|' + selectedIdContratos }) // Puedes enviar el nombre del archivo si es necesario
            });

            if (response.ok) {

                // Se descargó correctamente, redirige la respuesta a una nueva ventana
                const blob = await response.blob();

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');

                a.href = url;

                //Nombre Archivo
                const fechaHoraActual = new Date().toISOString().replace(/[-:]/g, "").replace(/\.\d{3}/, "");
                const nombreArchivo = `Estados_Cuenta_Navistar_${fechaHoraActual}.zip`;

                a.download = nombreArchivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
		        CerrarPopupProcesando();

            } else {
                // Manejo de errores
                console.error('Error al descargar el archivo ZIP');
                CerrarPopupProcesando();

            }
        } catch (error) {
            // Manejo de errores para cualquier excepción durante la llamada a fetch
            CerrarPopupProcesando();
            console.error('Error en la llamada a fetch:', error);
        }
    }

    function mostrarAlerta(tipo, mensaje) {
       // Elimina cualquier alerta existente
       $('.alert').remove();

       // Crea el elemento de alerta
       var alerta = $('<div class="alert alert-dismissible" role="alert" style="text-align:center;">')
           .addClass('alert-' + tipo)
           .html('<button type="button" class="close" data-dismiss="alert" aria-label="Close">&times;</button>' + mensaje);

       // Agrega la alerta al cuerpo del documento
       $('body').append(alerta);

       // Desaparece la alerta después de 3 segundos
       setTimeout(function () {
           alerta.fadeOut('slow', function () {
               alerta.remove();
           });
       }, 3000);
    }



</script>



